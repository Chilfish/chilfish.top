---
interface Props {
  src: string
  alt: string
  width?: number | string
  height?: number | string
  placeholder?: string
  [key: string]: any
}

const {
  src,
  alt,
  width,
  height,
  placeholder = '/placeholder.webp',
  ...rest
} = Astro.props
---

<img
  data-src={src}
  alt={alt}
  src={placeholder}
  width={width}
  height={height}
  loading="lazy"
  decoding="async"
  {...rest}
/>

<script>
const imgObserver = new IntersectionObserver((entries) => {
  entries.forEach((entry) => {
    if (entry.isIntersecting) {
      const img = entry.target as HTMLImageElement
      const src = img.dataset.src!
      img.setAttribute('src', src)
      img.removeAttribute('data-src')
      imgObserver.unobserve(img)
    }
  })
})

function loadImgs() {
  const imgs = document.querySelectorAll('img')
  imgs.forEach((img) => {
    if (img.dataset.src)
      imgObserver.observe(img)
  })
}

loadImgs()

document.addEventListener('astro:after-swap', () => {
  loadImgs()
})
</script>
