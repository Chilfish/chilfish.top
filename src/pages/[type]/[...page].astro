---
import type { GetStaticPaths } from 'astro'

import Alert from '@cp/common/Alert.astro'
import PostTimeLine from '~/components/post/PostTimeLine.astro'
import Layout from '~/layouts/Layout.astro'
import PostDetails from '~/layouts/PostDetails.astro'
import BlogListLayout from '~/layouts/BlogListLayout.astro'

import { getAllPosts } from '~/utils'
import { pageSize } from '~/constant/config'
import type { Post, PostPage, PrevNext } from '~/types'

export const prerender = true

export const getStaticPaths = (async ({ paginate }) => {
  const posts = await getAllPosts()
  const [blogs, notes] = posts
  return [
    ...paginate(blogs, {
      pageSize,
      params: {
        type: 'blog',
      },
    }),
    ...paginate(notes, {
      pageSize: 1000,
      params: {
        type: 'note',
      },
    }),
    ...posts.flat().map((post, idx, _posts) => {
      const prevP = _posts[idx - 1] as Post | undefined
      const nextP = _posts[idx + 1] as Post | undefined

      return {
        props: {
          post,
          prev: {
            title: prevP?.data.title,
            link: prevP ? `/${prevP.collection}/${prevP.slug}/` : undefined,
          },
          next: {
            title: nextP?.data.title,
            link: nextP ? `/${nextP.collection}/${nextP.slug}/` : undefined,
          },
        },
        params: {
          page: post.slug,
          type: post.collection,
        },
      }
    }),
  ]
}) satisfies GetStaticPaths

type Props = {
  page: PostPage
  post: undefined
  prev: undefined
  next: undefined
} | {
  post: Post
  prev: PrevNext
  next: PrevNext
  page: undefined
}

const { post, page, prev, next } = Astro.props
const { type } = Astro.params

---

{
  post
    ? (
      <PostDetails
        post={post}
        next={next!}
        prev={prev!}
      />
    )
    : (type === 'blog'
      ? (
        <BlogListLayout
          page={page}
          title="Blogs"
          h1={`共有 ${page.total} 篇文章`}
        />
      )
      : (
        <Layout title="Notes timeline">
          <PostTimeLine
            title="一些笔记们"
            posts={page.data}
          />
        </Layout>
      )
    )
}
